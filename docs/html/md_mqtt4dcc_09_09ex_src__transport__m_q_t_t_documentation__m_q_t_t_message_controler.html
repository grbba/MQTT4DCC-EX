<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DCC-EX MQTT: MQTT Message Controler</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="dccex-stylesheet.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Dccpplogov2.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DCC-EX MQTT
   &#160;<span id="projectnumber">0.1</span>
   </div>
   <div id="projectbrief">MQTT support for the DCC-EX command station for model railroading</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md_mqtt4dcc_09_09ex_src__transport__m_q_t_t_documentation__m_q_t_t_message_controler.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">MQTT Message Controler </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md10"></a>
Protocol</h1>
<p>The following describes DCC MQTT structure. The first paragraph contains the topic structure and the second the message format accepted by the <a class="el" href="class_dcc_m_q_t_t.html">DccMQTT</a> controller.</p>
<p>At this point in time the message structure is based on the JRMI command structure and the DCC API for making the mapping straight forward. More high level commands can be integrated as well as if needed a very small message footprint is possible as well at the cost of limited readability and more processing needed on the client side issuing the commands.</p>
<p>The protocol has two components to it: Topics and a specific syntax/semantic for messages send by the MQTT broker depending on the topic used. The format for messages send to any topic or published into any topic is JSON.</p>
<h2><a class="anchor" id="autotoc_md11"></a>
Topic structure</h2>
<p>All topics start with a term identifying the intent. _/command_ e.g. its intent is to send a command to the command station expecting or not a reply. Existing intents are:</p>
<ul>
<li>/command : commands for operations / programming etc.</li>
<li>/result : results coming back from previously issued commands</li>
<li>/admin : for administrative purposes</li>
<li>/telemetry : used for sending heartbeat data; memory consumption; ack currents etc ...</li>
<li>/diag : used for pushing diagnostic, debug or error messages</li>
</ul>
<h3><a class="anchor" id="autotoc_md12"></a>
/command &amp; /result</h3>
<p>The /command and /result intent topics are constructed the following way: </p><pre class="fragment">command/&lt;CSID&gt;/[L|T|S|A]; will only be used for recieving MQTT messages representing a command.
response/&lt;CSID&gt;; will only be used for publishing results either with the nuleric result when available or succes/fail
</pre><p>where <code>CSID</code> is the Unique ID obtained from the processor. The Unique ID is obtained during the setup routines and published to the /admin channel. The next level in the topic structure represents the ressources we look at:</p>
<p><b>L = Locomotive or Layout</b> everything which can be done with a loco or powering your layout. Anything abstracting away the address shall be done on the API server who connects to the MQTT broker for the distribution of commands / reception of values from CV reads. This is done to avoid storage/processing overhead to map names to loco addresses. The layout configuration and locos present on the layout are assumed to have been loaded as soon as the command station comes online through the API through some management topics yet to be defined. The commands or payload to be send to this topic are of the following structure </p><pre class="fragment">{c:&lt;command&gt;, cid:&lt;#&gt;, p:&lt;parameters&gt;} with 

&lt;command&gt; :: read|write|throttle|function|power

the parameters for the different commands are:

read &lt;parameters&gt; :: {cv:&lt;#&gt; [bit:&lt;#&gt;]}
write &lt;parameters&gt; :: {track:[M|P], cv:&lt;#&gt;,[locomotive:&lt;#&gt;], [bit:&lt;#&gt;], value:&lt;#&gt;}
    if the bit number is provided value must be 0 or 1
    if the track is M locomotive has to be provided
throttle &lt;parameters&gt; :: {locomotive:&lt;#&gt;, speed:&lt;#&gt;, direction:[F|R]}
function &lt;parameters&gt; :: {fn:&lt;#&gt;, state:[ON|OFF]}
power &lt;parameters&gt; :: {track:[M|P|A], state:[ON|OFF]};  M = main track, P = Programming track, A = both

Examples:

Reading CV1

{"c":"read", "cid":"12345", "p":{"cv":"1"}} will read the value from CV1

on the result topic the answer would be 

{"result":3, "cid":"12345"};

Power on all tracks:

{"c":"power", "cid":"12345", "p":{"track":"A", "state":"ON"}} will power up both tracks

on the result topic the answer would be 

{"result":"succes", "cid":"12345"};

&lt;#&gt; denotes an integer value

Note(1):cid stands for correlation id. This is a unique number to be set by the sender allowing him to 
link a message send on /command topic to the result recieved in the /result topic.

Note(2): to self: switch track state or provide the track in every call who can handle both ? 
</pre><p><b>T = Turnout</b> - operations for switch turnouts - TBD</p>
<p><b>S = Sensor</b> - setting getting sensor values - TBD</p>
<p><b>A = Accessory</b> - idem for Accesroes - TBD</p>
<h3><a class="anchor" id="autotoc_md13"></a>
/admin</h3>
<p>To be done; All admin related stuff</p>
<h3><a class="anchor" id="autotoc_md14"></a>
/telemetry</h3>
<p>To be done; collect operational metrics from the command station</p>
<h3><a class="anchor" id="autotoc_md15"></a>
/diag</h3>
<p>To be done; publish diagnostic / debugging messages</p>
<h1><a class="anchor" id="autotoc_md16"></a>
Design considerations</h1>
<p>Message pooling and double queues one for incoming and one for outgoing messages as responses to commands. Both are handled asynchronously </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.18 </li>
  </ul>
</div>
</body>
</html>
